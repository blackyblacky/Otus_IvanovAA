with cte as
(
SELECT SUM(l.UnitPrice*l.Quantity) as total, l.StockItemID 
FROM Sales.OrderLines AS l
Join Sales.Orders AS r
On r.OrderID = l.OrderID
join Sales.Invoices as n on n.CustomerID = r.CustomerID
group by l.StockItemID
)
Select o.CustomerID, ol.StockItemID, SUM(ol.UnitPrice), SUM(ol.Quantity), COUNT(o.OrderID)
from Sales.Orders as o
join Sales.OrderLines as ol on ol.OrderID = o.OrderID
join Warehouse.StockItems as s on s.StockItemID = ol.StockItemID
join Warehouse.StockItemTransactions as st on st.StockItemID = ol.StockItemID
join Sales.Invoices as i on i.OrderID = o.OrderID 
join Sales.CustomerTransactions as tr on tr.InvoiceID = i.InvoiceID
join cte as c on c.StockItemID = ol.StockItemID 
where i.BillToCustomerID != o.CustomerID and s.SupplierID = 12 and DATEDIFF(dd, i.InvoiceDate, o.OrderDate) = 0 and c.total > 250000
GROUP BY o.CustomerID, ol.StockItemID
ORDER BY o.CustomerID, ol.StockItemID